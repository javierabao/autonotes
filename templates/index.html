<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AutoNotes - Smart Lecture Notes</title>
  <!-- Favicon: same SVG used in the header so the tab shows the app icon -->
  <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M6 4C4.89543 4 4 4.89543 4 6V18C4 19.1046 4.89543 20 6 20H18C19.1046 20 20 19.1046 20 18V6C20 4.89543 19.1046 4 18 4H6ZM8.5 7.5H15.5C15.7761 7.5 16 7.72386 16 8C16 8.27614 15.7761 8.5 15.5 8.5H8.5C8.22386 8.5 8 8.27614 8 8C8 7.72386 8.22386 7.5 8.5 7.5ZM8.5 10.5H15.5C15.7761 10.5 16 10.7239 16 11C16 11.2761 15.7761 11.5 15.5 11.5H8.5C8.22386 11.5 8 11.2761 8 11C8 10.7239 8.22386 10.5 8.5 10.5ZM8.5 13.5H12.5C12.7761 13.5 13 13.7239 13 14C13 14.2761 12.7761 14.5 12.5 14.5H8.5C8.22386 14.5 8 14.2761 8 14C8 13.7239 8.22386 13.5 8.5 13.5Z' fill='%23395E66'/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      :root{
        --bg: #f6f7f9;
        --card: #ffffff;
        --muted: #395E66;
        --accent: #395E66; /* darkest teal */
        --accent-2: #387D7A; /* medium teal */
        --success: #32936F; /* green teal */
        --highlight: #26A96C; /* bright green */
        --radius: 12px;
      }
      html,body{height:100%;}
      body {
        font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
        margin: 0;
        min-height: 100vh;
        background: linear-gradient(180deg, var(--bg), #eef2f6 120%);
        color: var(--accent);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        padding: 3rem 1.5rem;
      }
      .container {
        width: 100%;
        max-width: 900px;
        background: var(--card);
        border-radius: var(--radius);
        box-shadow: 0 8px 30px rgba(16,24,40,0.08);
        padding: 2rem;
        margin: 0 auto;
        margin-bottom: 2rem;
      }
      h1{margin:0 0 .25rem 0; font-weight:600; letter-spacing:-0.02em}
      .hint { color: var(--muted); font-size: .95rem; margin-bottom:1rem }
      form{display:flex; flex-direction:column; gap:1.5rem; align-items:center}
      label.file-input{
        width: 100%;
        max-width: 480px;
        padding: 2rem;
        border: 2px dashed var(--accent-2);
        border-radius: var(--radius);
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      label.file-input:hover {
        border-color: var(--highlight);
        background: rgba(38, 169, 108, 0.05);
      }
      label.file-input.has-image {
        padding: 1rem;
        border-style: solid;
        background: rgba(57,94,102,0.03);
      }
      label.file-input.has-image:hover {
        background: rgba(57,94,102,0.05);
      }
      input[type=file]{
        display: none;
      }
      .generate-btn {
        background: var(--accent-2);
        color: white;
        font-size: 1.1rem;
        padding: 0.8rem 2rem;
        border-radius: var(--radius);
        border: 0;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
      }
      .generate-btn:hover {
        background: var(--highlight);
      }
      .download-actions{
        display: none;
        gap: 1rem;
        margin-top: 1rem;
      }
      .download-btn {
        background: var(--success);
        color: white;
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        border: 0;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }
      .download-btn:hover {
        background: var(--highlight);
      }
      button{background:var(--accent-2); color:white; border:0; padding:.7rem 1rem; border-radius:10px; cursor:pointer; font-weight:600; transition: all 0.2s ease}
      button:hover{background:var(--highlight)}
      button#preview-btn{background:transparent; color:var(--accent-2); border:1px solid var(--accent-2)}
      button#preview-btn:hover{background:var(--accent-2); color:white}
      button:disabled{opacity:.6; cursor:not-allowed}
      #progress{
        margin: 1.5rem auto;
        max-width: 400px;
        text-align: center;
      }
      .spinner {
        display: none;
        width: 40px;
        height: 40px;
        margin: 20px auto;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--accent-2);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      #preview{margin-top:1.25rem}
      #preview h3{margin:.25rem 0}
      #preview{
        display: none;
      }
      #preview-content{
        background:#f8fafc;
        color:#0f172a;
        padding:1.25rem;
        border-radius:8px;
        line-height:1.6;
        font-size:1rem;
        border:1px solid #e2e8f0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      }
      #preview-content h1 { color: var(--accent); margin-top: 0; }
      #preview-content h2, 
      #preview-content h3 { color: var(--accent-2); }
      #preview-content ul { padding-left: 1.5rem; }
      #preview-content li { margin: 0.5rem 0; }
      #preview-content p { margin: 1rem 0; }
      #preview-content code { 
        background: rgba(57,94,102,0.1);
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-size: 0.9em;
      }
      #download-md{
        background:var(--success);
        border-radius:8px;
        color:white;
        padding:.5rem .75rem;
        border:0;
        cursor:pointer;
        transition: all 0.2s ease;
      }
      #download-md:hover{
        background:var(--highlight);
      }
      @media (max-width:640px){
        body{padding:1.25rem 1rem}
        .container{padding:1.25rem}
        form{flex-direction:column}
      }
      @media (min-height: 800px) {
        body {
          padding-top: 2rem;
          padding-bottom: 2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div style="display:flex; align-items:center; gap:1rem; margin-bottom:1rem;">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 4C4.89543 4 4 4.89543 4 6V18C4 19.1046 4.89543 20 6 20H18C19.1046 20 20 19.1046 20 18V6C20 4.89543 19.1046 4 18 4H6ZM8.5 7.5H15.5C15.7761 7.5 16 7.72386 16 8C16 8.27614 15.7761 8.5 15.5 8.5H8.5C8.22386 8.5 8 8.27614 8 8C8 7.72386 8.22386 7.5 8.5 7.5ZM8.5 10.5H15.5C15.7761 10.5 16 10.7239 16 11C16 11.2761 15.7761 11.5 15.5 11.5H8.5C8.22386 11.5 8 11.2761 8 11C8 10.7239 8.22386 10.5 8.5 10.5ZM8.5 13.5H12.5C12.7761 13.5 13 13.7239 13 14C13 14.2761 12.7761 14.5 12.5 14.5H8.5C8.22386 14.5 8 14.2761 8 14C8 13.7239 8.22386 13.5 8.5 13.5Z" fill="currentColor"/>
        </svg>
        <div>
          <h1 style="font-family:'Space Grotesk',sans-serif; color:var(--accent); margin:0; font-size:2rem;">AutoNotes</h1>
          <p style="margin:0; color:var(--accent-2); font-size:1rem;">Turn photos into smart lecture notes</p>
        </div>
      </div>
      <p class="hint">Upload an image of a whiteboard, slide, or handwritten notes. AutoNotes will extract the text, format it beautifully, and create a downloadable document.</p>

      <form id="upload-form" action="/process" method="post" enctype="multipart/form-data">
        <label class="file-input">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" style="margin-bottom:0.5rem">
            <path d="M9 12h6m-3-3v6m6-9v12a2 2 0 01-2 2H8a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <div id="upload-prompt">
            <div style="font-weight:600; margin-bottom:0.25rem">Choose an image to process</div>
            <div style="color:var(--muted); font-size:0.9rem">Drop a photo of your whiteboard, slides, or notes</div>
          </div>
          <div id="upload-preview" style="display: none; width: 100%;">
            <img id="preview-img" style="max-width: 100%; max-height: 200px; object-fit: contain; border-radius: 6px; margin-bottom: 0.5rem;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <span id="file-name" style="color: var(--muted); font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
              <div style="display:flex; gap:0.5rem; align-items:center;">
                <button type="button" id="change-file" style="padding: 4px 8px; font-size: 0.8rem; background: transparent; color: var(--accent-2); border: 1px solid currentColor;">Change</button>
                <button type="button" id="remove-file" style="padding: 4px 8px; font-size: 0.8rem; background: transparent; color: #b71c1c; border: 1px solid rgba(183,28,28,0.12);">Remove</button>
              </div>
            </div>
          </div>
          <input id="file-input" type="file" name="file" accept="image/*" required>
        </label>

        <button id="generate-btn" type="button" class="generate-btn" disabled>Generate Notes</button>
      </form>

      <div id="progress" style="display:none;">
        <div id="progress-text" style="margin-bottom:.5rem; font-size:.9rem; color:var(--muted); text-align:center;"></div>
        <div id="processing-spinner" class="spinner"></div>
      </div>

      <div id="preview" style="margin-top:2rem;">
        <div id="preview-content"></div>
        <div class="download-actions">
          <button id="download-md" class="download-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path d="M12 16l-4-4h8l-4 4zm0-12v8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M20 18H4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Download .md
          </button>
          <button id="download-docx" class="download-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path d="M12 16l-4-4h8l-4 4zm0-12v8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M20 18H4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Download .docx
          </button>
        </div>
      </div>

      <hr>
      <p class="hint">Note: the first run may download a model and take a while.</p>

      <script>
        const form = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-input');
        const generateBtn = document.getElementById('generate-btn');
        const progress = document.getElementById('progress');
        const progressText = document.getElementById('progress-text');
        const previewDiv = document.getElementById('preview');
        const previewContent = document.getElementById('preview-content');
        const downloadMdBtn = document.getElementById('download-md');
        const downloadDocxBtn = document.getElementById('download-docx');
        const downloadActions = document.querySelector('.download-actions');

        const uploadPrompt = document.getElementById('upload-prompt');
        const uploadPreview = document.getElementById('upload-preview');
        const previewImg = document.getElementById('preview-img');
        const fileName = document.getElementById('file-name');
        const changeFileBtn = document.getElementById('change-file');

        function updateFilePreview(file) {
          if (file) {
            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
              previewImg.src = e.target.result;
              fileName.textContent = file.name;
              uploadPrompt.style.display = 'none';
              uploadPreview.style.display = 'block';
              dropZone.classList.add('has-image');
              generateBtn.disabled = false;
            };
            reader.readAsDataURL(file);
          } else {
            // Reset preview
            previewImg.src = '';
            fileName.textContent = '';
            uploadPrompt.style.display = 'block';
            uploadPreview.style.display = 'none';
            dropZone.classList.remove('has-image');
            generateBtn.disabled = true;
          }
        }

        // Handle file selection
        fileInput.addEventListener('change', () => {
          const file = fileInput.files[0];
          updateFilePreview(file);
        });

        // Handle change file button
        changeFileBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          fileInput.click();
        });

        // Handle remove file button
        const removeFileBtn = document.getElementById('remove-file');
        removeFileBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          // Clear the file input and reset preview
          fileInput.value = '';
          updateFilePreview(null);
        });

        // Handle file drop on the input label
        const dropZone = document.querySelector('.file-input');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults (e) {
          e.preventDefault();
          e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
          dropZone.addEventListener(eventName, () => {
            dropZone.classList.add('highlight');
          }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, () => {
            dropZone.classList.remove('highlight');
          }, false);
        });

        dropZone.addEventListener('drop', (e) => {
          const dt = e.dataTransfer;
          const files = dt.files;
          fileInput.files = files;
          updateFilePreview(files[0]);
        }, false);

        // Generate notes handler
        generateBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          if (!fileInput.files || !fileInput.files.length) return;

          let generatedMarkdown = null;
          const fd = new FormData();
          fd.append('file', fileInput.files[0]);
          fd.append('output_format', 'md');
          fd.append('preview', 'true');

          progress.style.display = 'block';
          previewDiv.style.display = 'none';
          downloadActions.style.display = 'none';
          generateBtn.disabled = true;

          try {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/process');

            const spinner = document.getElementById('processing-spinner');
            
            xhr.upload.onload = function() {
              progressText.textContent = 'Processing with AI model...';
              spinner.style.display = 'block';
            };

            xhr.onload = function() {
              if (xhr.status >= 200 && xhr.status < 300) {
                try {
                  const json = JSON.parse(xhr.responseText);
                  progressText.textContent = 'Formatting complete!';
                  
                  // Store the generated markdown
                  generatedMarkdown = json.text;
                  
                  // Render markdown preview
                  previewContent.innerHTML = marked.parse(generatedMarkdown);
                  previewDiv.style.display = 'block';
                  downloadActions.style.display = 'flex';
                  
                  // Setup markdown download
                  downloadMdBtn.onclick = () => {
                    const blob = new Blob([generatedMarkdown], {type: 'text/markdown;charset=utf-8'});
                    downloadFile(blob, 'md');
                  };
                  
                  // Setup docx download
                  downloadDocxBtn.onclick = async () => {
                    const spinner = document.getElementById('processing-spinner');
                    const progressText = document.getElementById('progress-text');

                    // Show progress bar/text but DO NOT show the spinner during DOCX conversion
                    progress.style.display = 'block';                    
                    try {
                      const fd = new FormData();
                      // Send the markdown content as form field
                      fd.append('markdown_content', generatedMarkdown);
                      fd.append('output_format', 'docx');
                      // Send original filename for better naming
                      fd.append('file', new Blob([''], { type: 'text/plain' }), 
                        fileInput.files[0].name.replace(/\.[^/.]+$/, '') + '.txt');
                      
                      const response = await fetch('/process', {
                        method: 'POST',
                        body: fd
                      });

                      if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Server error: ${errorText}`);
                      }

                      const blob = await response.blob();
                      if (!blob || blob.size === 0) {
                        throw new Error('Generated DOCX file is empty');
                      }
                      
                      downloadFile(blob, 'docx');
                    } catch (err) {
                      console.error('DOCX generation error:', err);
                      progressText.textContent = 'Failed to generate DOCX: ' + err.message;
                    } finally {
                      // hide progress text after a short delay; spinner was not shown here
                      setTimeout(() => {
                        progress.style.display = 'none';
                        spinner.style.display = 'none';
                      }, 1000);
                    }
                  };
                } catch (err) {
                  progressText.textContent = 'Failed to process the response.';
                }
              } else {
                progressText.textContent = 'Failed to generate notes: ' + xhr.statusText;
              }
              
              // Reset UI elements
              spinner.style.display = 'none';
              setTimeout(() => {
                progress.style.display = 'none';
                generateBtn.disabled = false;
              }, 1000);
            };

            xhr.onerror = function() {
              progressText.textContent = 'Upload failed.';
              spinner.style.display = 'none';
              progress.style.display = 'none';
              progressBar.style.width = '0%';
              generateBtn.disabled = false;
            };

            xhr.send(fd);
          } catch (err) {
            progressText.textContent = 'Error: ' + err.message;
            generateBtn.disabled = false;
          }
        });

        function downloadFile(blob, ext) {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = (fileInput.files[0].name.replace(/\.[^/.]+$/, '') || 'notes') + '.' + ext;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }
      </script>
    </div>
  </body>
</html>
